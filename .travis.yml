---
os: linux
dist: jammy
language: python
python:
  - '3.10'
before_install:
  - pip install --upgrade pip setuptools
branches:
  only:
    - main
jobs:
  include:
    - name: Check YAML format
      install:
        - pip install tox
      script:
        - tox -e yamllint
    - name: pymarkdown
      install:
        - pip install tox
      script:
        - tox -e pymarkdown
    - name: flake8
      install:
        - pip install tox
      script:
        - tox -e flake8
    - name: Check Bash format
      install:
        - pip install tox
      script:
        - tox -e shellcheck
    - name: Test
      service:
        - docker
      addons:
        # For the `SONARQUBE_SCANNER_PARAMS` variable
        sonarcloud:
          token: ${SONAR_TOKEN}
      install:
        - pip install tox
      script:
        - tox -e test
        - >
          docker run --rm
          -e SONARQUBE_SCANNER_PARAMS
          -e SONAR_TOKEN="${SONAR_TOKEN}"
          -v "`pwd`:/usr/src"
          sonarsource/sonar-scanner-cli
    - name: Integration Test for Results
      install:
        - pip install -r requirements.txt
      script:
        - bash integrationTestPrepration.sh
        - python patas.py Truku D-TL01-005.xlsx
        - cat D-TL01-005.txt
        - cat D-TL01-005.csv
    - name: Integration Test for Coverage
      install:
        - pip install tox
        - pip install -r requirements.txt
      script:
        - bash integrationTestPrepration.sh
        - tox -e test
        - coverage run -a patas.py Truku D-TL01-005.xlsx
        - coverage run -a patas.py Pangcah D-PV01.xlsx
        - coverage run -a patas.py Seediq D-SL07-001.xlsx
        - >
          docker run --rm
          -e SONARQUBE_SCANNER_PARAMS
          -e SONAR_TOKEN="${SONAR_TOKEN}"
          -v "`pwd`:/usr/src"
          sonarsource/sonar-scanner-cli
